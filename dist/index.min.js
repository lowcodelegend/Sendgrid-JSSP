metadata={systemName:"com.demo.sendgrid.email",displayName:"SendGrid Email Broker (HTTP)",description:"Sends emails using the SendGrid Web API directly.",configuration:{apiKey:{displayName:"SendGrid API Key",type:"string",required:!0}}},ondescribe=async function(){postSchema({objects:{email:{displayName:"Email",description:"An email message to send via SendGrid.",properties:{to:{displayName:"To",type:"string"},from:{displayName:"From",type:"string"},subject:{displayName:"Subject",type:"string"},text:{displayName:"Text Body",type:"string"},html:{displayName:"HTML Body",type:"string"},status:{displayName:"Status",type:"string"}},methods:{send:{displayName:"Send Email",type:"create",inputs:["to","from","subject","text","html"],outputs:["status"]}}}}})},onexecute=async function({objectName:e,methodName:t,properties:s,parameters:a,configuration:i}){if("email"!==e)throw new Error("Object '"+e+"' not supported.");await async function(e,t,s){if("send"!==e)throw new Error("Method '"+e+"' is not supported.");await async function(e,t){return new Promise(((s,a)=>{const i="https://api.sendgrid.com/v3/mail/send",n=new XMLHttpRequest;n.open("POST",i),n.setRequestHeader("Authorization","Bearer "+String(t.apiKey)),n.setRequestHeader("Content-Type","application/json");const r={personalizations:[{to:[{email:e.to}],subject:e.subject}],from:{email:e.from},content:[{type:"text/plain",value:e.text||""}]};e.html&&r.content.push({type:"text/html",value:e.html}),n.onreadystatechange=function(){if(4===n.readyState)try{n.status>=200&&n.status<300?(postResult({status:String(n.status)}),s()):a(new Error("SendGrid send failed: "+n.status+" - "+n.responseText))}catch(e){a(e)}},n.send(JSON.stringify(r))}))}(t,s)}(t,s,i)};
